---
layout: post
title: Evasión de MOTW y Ocultamiento con Flujos de Datos Alternativos en Windows
date: 2025-08-18
author:
  name: Suzunao
  avatar: /assets/img/icon/Suzunao.png
tags:
  - windows 
  - ADS
  - NTFS
background: https://miro.medium.com/v2/resize:fit:828/format:webp/1*95_lICJ58uYfNWLa1QZ9uQ.jpeg
---
### Flujos de Datos Alternativos (Alternate Data Streams - ADS) en NTFS.

Los Flujos de Datos Alternativos (ADS) son una característica del sistema de archivos **NTFS** (New Technology File System) que permite asociar múltiples flujos de datos a un solo archivo o directorio. Esto permite ocultar cargas útiles u otros tipos de datos dentro de archivos legítimos, lo que dificulta que el software antivirus detecte el malware.

ejemplo:

```
echo "Pope is a rockstart!" >  hello.txt:pope.txt ## Crea un ADS llamado pope.txt dentro de hello.txt
```

![descripcion](/assets/img/articulos/A01/20250607020853.png) 

Con esto crea un flujo oculto (ADS) asociándolo al archivo `hello.txt`. Una vez oculto, únicamente se visualizará el archivo `hello.txt`, mientras que el flujo `pope.txt` permanecerá oculto, a menos que se ejecute el comando `dir /r`, el cual permite listar los archivos junto con sus flujos ADS asociados.

![descripcion](/assets/img/articulos/A01/d44975.png)

Para poder visualizar el contenido del archivo oculto  utilizamos `more < hello.txt:pope.txt` 

### Zone.Identifier (MOTW)

Uno de los usos legítimos de flujos de datos alternativos es Zone.Identifier,  comúnmente conocida como Marca de la Web (abreviada MOTW), windows la utiliza  desde Windows XP SP2.  Esta muestra un número que indica la zona de seguridad de la que proviene el archivo. 

![descripción](/assets/img/articulos/A01/20250610025838.png)

Valores posibles de  Zone.Identifier:
- 0 - Mi Computadora  
- 1 - Zona Intranet Local  
- 2 - Sitios de confianza Zona  
- 3 - Zona de Internet  
- 4 - Zona de Sitios Restringidos
- **ReferrerURL** – El sitio web desde el que se descargó el archivo (si está disponible)
- **HosTURL** – El enlace de descarga directa (si está disponible)

Esto es interesante ya que se puede editar el Zone.Identifier para pasar evitar alertas.
Como ejemplo podemos tomar un word:

![descripción](/assets/img/articulos/A01/20250610015526.png)

Si el valor de `ZoneId` es 3 (Internet) o 4 (Restricted), Word abrirá el documento en Vista Protegida.
Cambiar este valor a 0  puede, en algunos casos, evitar que se active dicha vista. 

![descripción](/assets/img/articulos/A01/20250610020036.png)

Este comportamiento depende también de la configuración de seguridad del sistema y de las políticas de grupo aplicadas ya que se puede evadir configurando [HideZoneInfoOnPropiedades](https://support.microsoft.com/en-us/help/883260/information-about-the-attachment-manager-in-microsoft-windows)a través de la política de grupo.

### **Caso de uso hipotético**.

En un escenario hipotético, si la víctima utiliza una versión vulnerable de 7-Zip afectada por la [**CVE-2025-0411** ](https://github.com/dhmosfunk/7-Zip-CVE-2025-0411-POC?tab=readme-ov-file) esta vulnerabilidad podría ser explotada, en combinación con técnicas de ingeniería social. Por ejemplo, mediante un dominio fraudulento se podría inducir a la víctima a descargar y descomprimir un archivo malicioso. El flujo de ataque sería el siguiente:

- Creamos nuestro dominio fraudulento utilizando Apache y empleamos Vortex para establecer un túnel reverso que expone el servicio local a Internet.

![descripción](/assets/img/articulos/A01/065356.png)

- En la estructura de Apache, dentro del directorio de documentos, se encuentra el archivo `informe01.7z`, que contiene una carga maliciosa. En este caso particular, se anidó el archivo `informe.7z` dentro de `informe01.7z`, aunque lo habitual es enviar únicamente un único archivo `.7z`.

- La víctima accede al dominio y descarga el archivo `.7z` con la intención de descomprimirlo y revisar la información contenida. 

![descripción](/assets/img/articulos/A01/025337.png)

- Antes de la descompresión, cabe destacar que la víctima tiene en su escritorio dos archivos `.txt` con contraseñas, los cuales son el objetivo del ejecutable malicioso contenido en el `.7z`.

![descripción](/assets/img/articulos/A01/025859.png)

- Al descomprimir `informe01.7z`, se obtiene un segundo archivo comprimido llamado `informe.7z`, el cual contiene la siguiente estructura:

```
informe01.7z
└──	informe7.z
	├── infome.docx.lnk          
	└── otros\
	    ├── informe01.docx
	    ├── pepeinfo.exe        
	    ├── imagen.jpg
	    └── run.vbs           
```

![Contenido de \otros en la maquina victima](/assets/img/articulos/A01/025721.png)

- El flujo malicioso inicia cuando el usuario hace clic en el acceso directo `informe.docx.lnk`. Este acceso apunta al script `run.vbs`, el cual, al ejecutarse, abre el archivo señuelo `informe01.docx` para distraer al usuario, mientras en segundo plano ejecuta el binario `pepeinfo.exe`.
- Posteriormente, el script `run.vbs` aplica una técnica de ofuscación: oculta el archivo `pepeinfo.exe` dentro de `imagen.jpg` mediante un flujo de datos alternativo (ADS) y, además, se esconde a sí mismo como ADS dentro del documento `informe01.docx`, reduciendo así la probabilidad de detección.

	https://youtu.be/AtKKu87qDS4

- En este flujo se lleva a cabo la evasión del Mark of the Web (MOTW). La vulnerabilidad CVE-2025-0411 en 7-Zip permite que, al descomprimir un archivo `.7z`, se eliminen los flujos de datos alternativos _Zone.Identifier_. Este comportamiento se confirma al observar que únicamente el archivo descargado (`informe01.7z`) conserva la marca MOTW, mientras que los archivos extraídos no heredan dicha etiqueta de seguridad.

![descripción](/assets/img/articulos/A01/025519.png)

- Como resultado, si el usuario interactúa con los archivos extraídos (como el `.lnk` o el `.exe`), no se generan advertencias de seguridad por parte de Windows, permitiendo la ejecución de cargas maliciosas sin alertar al usuario, de lo contrario saltaría la siguiente alerta.

![descripción](/assets/img/articulos/A01/053609.png) 

- Para reforzar la ofuscación, los ejecutables se incrustan dentro de archivos aparentemente legítimos, haciendo parecer que no ocurrió ninguna actividad sospechosa. Internamente, los archivos muestran presencia de flujos ADS.

![descripción](/assets/img/articulos/A01/025635.png)

Este tipo de técnica puede aprovecharse para mantener persistencia en el sistema comprometido, dependiendo de la naturaleza de la carga y del contexto del objetivo.

Este caso hipotético sirve como un ejemplo de la importancia de mantener herramientas actualizadas, desconfiar de archivos comprimidos desconocidos, y contar con soluciones de seguridad avanzadas capaces de detectar comportamientos anómalos más allá de las simples firmas o advertencias del sistema operativo.

Referencias:  
[Russian Cybercrime Groups Exploiting 7-Zip Flaw to Bypass Windows MotW Protections](https://thehackernews.com/2025/02/russian-cybercrime-groups-exploiting-7.html?m=1)

[Introduction to ADS — Alternate Data Streams](https://hshrzd.wordpress.com/2016/03/19/introduction-to-ads-alternate-data-streams/?source=post_page-----c0e4a2402563---------------------------------------)

[Mark-of-the-Web from a Red Team’s Perspective ](https://www.outflank.nl/blog/2020/03/30/mark-of-the-web-from-a-red-teams-perspective/)

[GitHub — dhmosfunk/7-Zip-CVE-2025–0411-POC: This repository contains POC scenarios as part of CVE-2025–0411 MotW bypass.](https://github.com/dhmosfunk/7-Zip-CVE-2025-0411-POC?tab=readme-ov-file)

[Information about the Attachment Manager in Microsoft Windows — Microsoft Support](https://support.microsoft.com/en-us/topic/information-about-the-attachment-manager-in-microsoft-windows-c48a4dcd-8de5-2af5-ee9b-cd795ae42738)